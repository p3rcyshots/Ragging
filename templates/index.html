<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RAG Chat</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background-color: #f4f4f4; }
        .header { background-color: #333; color: white; padding: 10px; display: flex; justify-content: flex-end; align-items: center; }
        .header span { margin-right: 20px; }
        .header a, .header button { color: white; text-decoration: none; background-color: #555; padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 14px; margin-left: 10px; }
        .chat-container { display: flex; flex: 1; overflow: hidden; }
        #chat-history { flex: 1; min-width: 200px; max-width: 300px; padding: 10px; overflow-y: auto; border-right: 1px solid #ccc; background-color: #fcfcfc; }
        .chat-list-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .chat-list-item:hover { background-color: #f0f0f0; }
        .chat-list-item.active { background-color: #d8eaff; font-weight: bold; }
        .delete-chat-btn { color: #dc3545; cursor: pointer; font-weight: bold; padding: 0 5px; font-size: 1.2em; display: none; }
        .chat-list-item:hover .delete-chat-btn { display: inline; }
        .delete-chat-btn:hover { color: #a71d2a; }
        #new-chat-btn { display: block; width: 90%; margin: 10px auto; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #chat-display-wrapper { flex: 3; display: flex; flex-direction: column; }
        #chat-display { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .message { max-width: 80%; padding: 10px; border-radius: 10px; margin-bottom: 5px; line-height: 1.4; word-wrap: break-word; }
        .user-message { background-color: #0084ff; color: white; align-self: flex-end; }
        .bot-message { background-color: #e5e5ea; color: black; align-self: flex-start; }
        .source-info { font-size: 0.8em; color: #555; background-color: #f0f0f0; padding: 5px 10px; border-radius: 5px; margin-top: -5px; margin-bottom: 10px; max-width: 80%; align-self: flex-start; }
        .input-area { display: flex; padding: 10px; border-top: 1px solid #ccc; background-color: #fff; }
        #message-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; }
        #send-button { padding: 10px 20px; margin-left: 10px; border: none; background-color: #007bff; color: white; border-radius: 20px; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .tab-container { overflow: hidden; border-bottom: 1px solid #ccc; margin-bottom: 15px; }
        .tab-container button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; }
        .tab-container button:hover { background-color: #ddd; }
        .tab-container button.active { background-color: #ccc; }
        .tab-content { display: none; padding: 6px 12px; }
        .tab-content.active { display: block; }
        .modal-content input, .modal-content select, .modal-content button { width: 95%; padding: 8px; margin-top: 5px; margin-bottom: 10px; }
        #admin-user-select, #admin-chat-list, #admin-chat-view { margin-top: 10px; }
        .admin-chat-item { padding: 8px; border: 1px solid #eee; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .admin-chat-item-title { cursor: pointer; flex-grow: 1; }
        .admin-chat-item-title:hover { background-color: #f0f0f0; }
        .admin-delete-btn { color: #dc3545; background: none; border: none; cursor: pointer; font-size: 1.2em; }
        #admin-chat-view { min-height: 100px; max-height: 300px; overflow-y: auto; background-color: #f9f9f9; border: 1px solid #ddd; padding: 10px; }
        #password-status { margin-top: 10px; font-weight: bold; }
        .status-success { color: green; }
        .status-error { color: red; }
    </style>
</head>
<body>
    <div class="header">
        <span>Welcome, {{ login_id }}</span>
        <button id="change-password-btn">Change Password</button>
        {% if is_admin %}
            <button id="admin-panel-btn">Admin Panel</button>
        {% endif %}
        <a href="/logout">Logout</a>
    </div>

    <div class="chat-container">
        <div id="chat-history">
            <h3>Chats</h3>
            <button id="new-chat-btn">New Chat</button>
            <div id="chat-list"></div>
        </div>
        <div id="chat-display-wrapper">
            <div id="chat-display"></div>
            <div class="input-area">
                <input type="text" id="message-input" placeholder="Ask a question...">
                <button id="send-button">Send</button>
            </div>
        </div>
    </div>

    <div id="password-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close-btn" id="password-close-btn">&times;</span>
            <h3>Change Password</h3>
            <label for="current-password">Current Password:</label>
            <input type="password" id="current-password" required>
            <label for="new-password">New Password:</label>
            <input type="password" id="new-password" required>
            <label for="confirm-password">Confirm New Password:</label>
            <input type="password" id="confirm-password" required>
            <button id="save-password-btn">Save Changes</button>
            <div id="password-status"></div>
        </div>
    </div>

    {% if is_admin %}
    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="admin-close-btn">&times;</span>
            <h2>Admin Panel</h2>
            <div class="tab-container">
                <button class="tab-link active" onclick="openTab(event, 'createUser')">Create User</button>
                <button class="tab-link" onclick="openTab(event, 'userChats')">User Chats</button>
            </div>
            <div id="createUser" class="tab-content active">
                <h3>Create New User</h3>
                <label for="new-email">User Email:</label>
                <input type="email" id="new-email" required>
                <label for="new-password-admin">Password (optional):</label>
                <input type="password" id="new-password-admin">
                <button id="create-user-btn">Create User</button>
            </div>
            <div id="userChats" class="tab-content">
                <h3>View User Chats</h3>
                <label for="admin-user-select">Select a User:</label>
                <select id="admin-user-select"><option value="">-- Select a User --</option></select>
                <div id="admin-chat-list"></div>
                <div id="admin-chat-view"></div>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL STATE ---
            let currentChatId = null;
            const isAdmin = {{ is_admin | tojson }};

            // --- UNIVERSAL ELEMENT SELECTORS ---
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const chatDisplay = document.getElementById('chat-display');
            const chatListDiv = document.getElementById('chat-list');
            const newChatBtn = document.getElementById('new-chat-btn');
            
            // --- MODAL ELEMENT SELECTORS ---
            const passwordModal = document.getElementById('password-modal');
            const changePasswordBtn = document.getElementById('change-password-btn');
            const passwordCloseBtn = document.getElementById('password-close-btn');
            const savePasswordBtn = document.getElementById('save-password-btn');
            const passwordStatus = document.getElementById('password-status');

            // --- FUNCTION DEFINITIONS ---
            function addMessageToDisplay(sender, text, displayElement, sources = []) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', sender.toLowerCase().includes('you') ? 'user-message' : 'bot-message');
                const senderHTML = `<b>${sender}:</b><br>`;
                const contentHTML = text.replace(/\n/g, '<br>');
                messageDiv.innerHTML = senderHTML + contentHTML;
                displayElement.appendChild(messageDiv);

                if (sources && sources.length > 0) {
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.className = 'source-info';
                    let sourcesText = 'Sources: ';
                    sourcesText += sources.map(s => {
                        let pageStr = '';
                        if (s.pages && s.pages.length > 0) {
                            pageStr = ` (Pages: ${s.pages.join(', ')})`;
                        }
                        return `${s.name}${pageStr}`;
                    }).join('; ');
                    sourcesDiv.textContent = sourcesText;
                    displayElement.appendChild(sourcesDiv);
                }
                displayElement.scrollTop = displayElement.scrollHeight;
            }

            async function sendMessage() {
                const question = messageInput.value.trim();
                if (!question) return;
                addMessageToDisplay('You', question, chatDisplay);
                messageInput.value = '';
                sendButton.disabled = true;
                try {
                    const response = await fetch('/api/ask', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question: question, chat_id: currentChatId })
                    });
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    const data = await response.json();
                    addMessageToDisplay('Bot', data.answer, chatDisplay, data.sources);
                    if (data.new_chat_id) {
                        currentChatId = data.new_chat_id;
                        await loadUserChats();
                    }
                } catch (error) {
                    console.error("Error sending message:", error);
                    addMessageToDisplay('Bot', 'Sorry, an error occurred while sending your message.', chatDisplay);
                } finally {
                    sendButton.disabled = false;
                    messageInput.focus();
                }
            }

            async function loadUserChats() {
                try {
                    const response = await fetch('/api/chats');
                    if (!response.ok) return;
                    const chats = await response.json();
                    chatListDiv.innerHTML = '';
                    chats.forEach(chat => {
                        const chatItem = document.createElement('div');
                        chatItem.className = 'chat-list-item';
                        chatItem.dataset.chatId = chat.id;

                        const chatTitle = document.createElement('span');
                        chatTitle.textContent = chat.title;
                        chatTitle.style.flexGrow = 1;
                        chatTitle.onclick = () => loadChatMessages(chat.id);

                        const deleteBtn = document.createElement('span');
                        deleteBtn.className = 'delete-chat-btn';
                        deleteBtn.innerHTML = '&times;';
                        deleteBtn.title = 'Delete Chat';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            deleteChat(chat.id, chatItem);
                        };

                        chatItem.appendChild(chatTitle);
                        chatItem.appendChild(deleteBtn);
                        
                        if (chat.id === currentChatId) {
                            chatItem.classList.add('active');
                        }
                        chatListDiv.appendChild(chatItem);
                    });
                } catch (e) { console.error("Failed to load user chats", e); }
            }
            
            async function deleteChat(chatId, elementToRemove) {
                if (!confirm('Are you sure you want to delete this chat permanently?')) {
                    return;
                }
                try {
                    const response = await fetch(`/api/chat/${chatId}`, { method: 'DELETE' });
                    const result = await response.json();
                    if (response.ok) {
                        elementToRemove.remove();
                        if (currentChatId === chatId) {
                            currentChatId = null;
                            chatDisplay.innerHTML = '';
                        }
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (err) {
                    alert('An unexpected network error occurred.');
                }
            }

            async function loadChatMessages(chatId) {
                currentChatId = chatId;
                chatDisplay.innerHTML = 'Loading messages...';
                document.querySelectorAll('.chat-list-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.chatId == chatId);
                });
                try {
                    const response = await fetch(`/api/chat/${chatId}`);
                    if (!response.ok) { chatDisplay.innerHTML = 'Error loading chat.'; return; }
                    const messages = await response.json();
                    chatDisplay.innerHTML = '';
                    messages.forEach(msg => addMessageToDisplay(msg.sender, msg.content, chatDisplay));
                } catch (e) { console.error("Failed to load chat messages", e); chatDisplay.innerHTML = 'Error loading chat.'; }
            }
            
            // --- ATTACH UNIVERSAL EVENT LISTENERS ---
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keydown', (event) => { if (event.key === 'Enter') sendMessage(); });
            newChatBtn.onclick = () => {
                currentChatId = null;
                chatDisplay.innerHTML = '';
                document.querySelectorAll('.chat-list-item.active').forEach(item => item.classList.remove('active'));
            };

            // --- ATTACH PASSWORD MODAL EVENT LISTENERS ---
            changePasswordBtn.onclick = () => {
                passwordModal.style.display = 'block';
                passwordStatus.textContent = '';
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            };
            passwordCloseBtn.onclick = () => passwordModal.style.display = 'none';
            savePasswordBtn.onclick = async () => {
                const current_password = document.getElementById('current-password').value;
                const new_password = document.getElementById('new-password').value;
                const confirm_password = document.getElementById('confirm-password').value;
                passwordStatus.className = 'status-error';
                if (new_password !== confirm_password) { passwordStatus.textContent = 'New passwords do not match.'; return; }
                if (!new_password) { passwordStatus.textContent = 'New password cannot be empty.'; return; }
                try {
                    const response = await fetch('/api/change_password', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ current_password, new_password, confirm_password })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        passwordStatus.className = 'status-success';
                        passwordStatus.textContent = result.message;
                        setTimeout(() => { passwordModal.style.display = 'none'; }, 2000);
                    } else { passwordStatus.textContent = 'Error: ' + result.error; }
                } catch (err) { passwordStatus.textContent = 'An unexpected network error occurred.'; }
            };
            
            // --- ADMIN-ONLY LOGIC ---
            if (isAdmin) {
                // Select admin elements only if the user is an admin
                const adminModal = document.getElementById('admin-modal');
                const adminBtn = document.getElementById('admin-panel-btn');
                const adminCloseBtn = document.getElementById('admin-close-btn');
                const userSelect = document.getElementById('admin-user-select');
                const adminChatListDiv = document.getElementById('admin-chat-list');
                const adminChatViewDiv = document.getElementById('admin-chat-view');
                const createUserBtn = document.getElementById('create-user-btn');

                // Attach admin event listeners
                adminBtn.onclick = async () => {
                    await populateUserList();
                    adminModal.style.display = 'block';
                };
                adminCloseBtn.onclick = () => adminModal.style.display = 'none';

                window.openTab = function(evt, tabName) {
                    document.querySelectorAll('#admin-modal .tab-content').forEach(tc => tc.classList.remove('active'));
                    document.querySelectorAll('#admin-modal .tab-link').forEach(tl => tl.classList.remove('active'));
                    document.getElementById(tabName).classList.add('active');
                    evt.currentTarget.classList.add('active');
                };

                async function populateUserList() {
                    try {
                        const response = await fetch('/api/admin/users');
                        const users = await response.json();
                        userSelect.innerHTML = '<option value="">-- Select a User --</option>';
                        users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.email;
                            userSelect.appendChild(option);
                        });
                    } catch (e) { console.error("Failed to populate user list", e); }
                }

                userSelect.onchange = async () => {
                    const userId = userSelect.value;
                    adminChatListDiv.innerHTML = 'Loading chats...'; adminChatViewDiv.innerHTML = '';
                    if (!userId) { adminChatListDiv.innerHTML = ''; return; }
                    try {
                        const response = await fetch(`/api/admin/user_chats/${userId}`);
                        const chats = await response.json();
                        adminChatListDiv.innerHTML = '';
                        if (chats.length === 0) { adminChatListDiv.textContent = 'No chats found for this user.'; return; }
                        
                        chats.forEach(chat => {
                            const chatItem = document.createElement('div');
                            chatItem.className = 'admin-chat-item';
                            const titleSpan = document.createElement('span');
                            titleSpan.className = 'admin-chat-item-title';
                            titleSpan.textContent = `ID ${chat.id}: ${chat.title}`;
                            titleSpan.onclick = () => viewChat(chat.id);
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'admin-delete-btn';
                            deleteBtn.innerHTML = '&times;';
                            deleteBtn.title = 'Delete Chat';
                            deleteBtn.onclick = () => adminDeleteChat(chat.id, chatItem);
                            chatItem.appendChild(titleSpan);
                            chatItem.appendChild(deleteBtn);
                            adminChatListDiv.appendChild(chatItem);
                        });
                    } catch(e) { console.error("Failed to load user chats for admin", e); }
                };

                async function adminDeleteChat(chatId, elementToRemove) {
                    if (!confirm(`ADMIN ACTION: Are you sure you want to permanently delete chat ID ${chatId}?`)) return;
                    try {
                        const response = await fetch(`/api/admin/chat/${chatId}`, { method: 'DELETE' });
                        const result = await response.json();
                        if (response.ok) {
                            elementToRemove.remove();
                            adminChatViewDiv.innerHTML = 'Chat has been deleted.';
                        } else {
                            alert('Error: ' + result.error);
                        }
                    } catch (err) { alert('An unexpected network error occurred.'); }
                }
                
                async function viewChat(chatId) {
                    adminChatViewDiv.innerHTML = 'Loading messages...';
                    try {
                        const response = await fetch(`/api/admin/chat_messages/${chatId}`);
                        const messages = await response.json();
                        adminChatViewDiv.innerHTML = '';
                        messages.forEach(msg => { addMessageToDisplay(msg.sender, msg.content, adminChatViewDiv); });
                    } catch(e) { console.error("Failed to load chat messages for admin", e); }
                }

                createUserBtn.onclick = async () => {
                    const email = document.getElementById('new-email').value;
                    const password = document.getElementById('new-password-admin').value;
                    if (!email) { alert('Email is required.'); return; }
                    try {
                        const response = await fetch('/api/admin/add_user', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert(result.message);
                            adminModal.style.display = 'none';
                            document.getElementById('new-email').value = '';
                            document.getElementById('new-password-admin').value = '';
                        } else { alert('Error: ' + result.error); }
                    } catch (err) { alert('An unexpected error occurred.'); }
                };
            }

            // Universal Modal Closing
            window.onclick = (event) => {
                const adminModal = document.getElementById('admin-modal');
                if (passwordModal && event.target == passwordModal) { passwordModal.style.display = 'none'; }
                if (adminModal && event.target == adminModal) { adminModal.style.display = 'none'; }
            };

            // --- INITIAL LOAD ---
            loadUserChats();
        });
    </script>
</body>
</html>